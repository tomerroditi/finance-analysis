name: Build and Release Installer

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build Installer and Release
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout Code
        uses: actions/checkout@v3

      - name: 🧰 Install Wine + Inno Setup
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y wine64 wine32 unzip wget

          wget https://jrsoftware.org/download.php/ispack-unicode.exe -O ispack.exe
          wine ispack.exe /VERYSILENT /DIR="C:\\inno"

      - name: 🧪 Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep -Po '(?<=version = ")[^"]+' finance-analysis/pyproject.toml | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT

      - name: 🔁 Inject version into installer_script.iss
        run: |
          sed -i "s/^AppVersion=.*/AppVersion=$VERSION/" finance-analysis/build/installer_script.iss

      - name: 🛠 Build Installer with Inno Setup
        run: |
          wine "C:\\inno\\ISCC.exe" "finance-analysis\\build\\installer_script.iss"

      - name: 📜 Generate Changelog
        id: changelog
        run: |
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          git log $(git describe --tags --abbrev=0)..HEAD --pretty=format:"- %s" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 🚀 Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Finance Analysis v${{ steps.version.outputs.tag_name }}"
          tag_name: ${{ steps.version.outputs.tag_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: FinanceAppInstaller.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
